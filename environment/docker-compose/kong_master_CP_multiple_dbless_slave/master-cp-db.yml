version: "3"
services:

 postgres:
  image: postgres:12.4
  restart: always
  container_name: postgres
  networks:
   - kong
  environment:
   - POSTGRES_USER=kong
   - POSTGRES_DB=kong
   - POSTGRES_PASSWORD=kong
   - POSTGRES_HOST_AUTH_METHOD=trust
   - POSTGRES_LOG_CONNECTIONS=on
   - POSTGRES_SSL_MIN_PROTOCOL_VERSION='TLSv1.1'

 kong-ent-bootstrap:
  image: ${KONG_IMAGE}
  container_name: kong-ent-bootstrap
  networks:
   - kong
  restart: on-failure
  command: "kong migrations bootstrap"
  depends_on:
   - postgres
  environment:
   - KONG_LICENSE_DATA=${KONG_LICENSE_DATA}
   - KONG_PASSWORD=admin
   - KONG_LOG_LEVEL=debug
   - KONG_VITALS=on
   - KONG_DATABASE=postgres
   - KONG_PG_HOST=postgres
   - KONG_PG_PASSWORD=kong

 kong-cp0:
   image: ${KONG_IMAGE} #
   container_name: kong-cp0
   networks:
    - kong
   restart: always
   command: "kong start --run-migrations" 
   volumes:
    - ../cert:/tmp/cert
   ports:
    - 8001:8001
    - 8002:8002
    - 8003:8003
    - 8004:8004
    - 8444:8444
    - 8445:8445
    - 8446:8446
    - 8447:8447
   depends_on:
    - kong-ent-bootstrap
   environment:
    - KONG_ROLE=control_plane
    - KONG_CLUSTER_CERT=/tmp/cert/hybrid_cert/cluster.crt
    - KONG_CLUSTER_CERT_KEY=/tmp/cert/hybrid_cert/cluster.key
    - KONG_CLUSTER_LISTEN=0.0.0.0:8005
    - KONG_DATABASE=postgres
    - KONG_PG_HOST=postgres
    - KONG_ANONYMOUS_REPORTS=off
#   - KONG_ENFORCE_RBAC=on
#   - KONG_ADMIN_GUI_AUTH=basic-auth
#   - KONG_ADMIN_GUI_SESSION_CONF={"secret":"secret","storage":"kong","cookie_secure":false}
    - KONG_PASSWORD=admin
    - KONG_AUDIT_LOG=on
    - KONG_LOG_LEVEL=debug 
    - KONG_PORTAL_GUI_PROTOCOL=http
    - KONG_PORTAL=on
    - KONG_PORTAL_AUTH=basic-auth
    - KONG_LICENSE_DATA=${KONG_LICENSE_DATA}
    - KONG_VITALS=on
    - KONG_PROXY_ACCESS_LOG=/dev/stdout
    - KONG_ADMIN_ACCESS_LOG=/dev/stdout
    - KONG_PROXY_ERROR_LOG=/dev/stderr
    - KONG_ADMIN_ERROR_LOG=/dev/stderr
    - KONG_PROXY_LISTEN=0.0.0.0:8000, 0.0.0.0:8443 ssl
    - KONG_STATUS_LISTEN=0.0.0.0:8100
    - KONG_ADMIN_LISTEN=0.0.0.0:8001, 0.0.0.0:8444 ssl
    - KONG_ADMIN_GUI_LISTEN=0.0.0.0:8002, 0.0.0.0:8445 ssl
    - KONG_PORTAL_GUI_LISTEN=0.0.0.0:8003, 0.0.0.0:8446 ssl
    - KONG_PORTAL_SESSION_CONF={"storage":"kong","cookie_name":"portal_session","secret":"super-secret","cookie_secure":false}
    - KONG_PORTAL_API_LISTEN=0.0.0.0:8004, 0.0.0.0:8447 ssl

networks:
  kong:
    ipam:
      driver: default
      config: 
        - subnet: 10.0.0.0/24 
